<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ODE Solver (Your Python Logic via Pyodide)</title>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.28);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 28px;
      text-align: center;
    }
    .header h1 { margin: 0 0 8px 0; font-size: 2.2rem; }
    .header p  { margin: 0; opacity: 0.92; }

    .content {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 22px;
      padding: 22px;
    }
    @media (max-width: 980px) {
      .content { grid-template-columns: 1fr; }
    }

    .controls {
      background: #f6f7fb;
      border: 1px solid #e7e8ef;
      padding: 18px;
      border-radius: 14px;
      height: fit-content;
    }
    .tabs { display: flex; gap: 10px; margin-bottom: 14px; }
    .tab {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d9dbe7;
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      color: #333;
    }
    .tab.active {
      background: #667eea;
      border-color: #667eea;
      color: #fff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-group { margin-bottom: 14px; }
    label {
      display: block;
      font-weight: 700;
      margin-bottom: 6px;
      color: #333;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d9dbe7;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    input:focus, select:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }

    .btn {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(102,126,234,0.25); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }

    .results { display: flex; flex-direction: column; gap: 16px; }
    .card {
      background: #f6f7fb;
      border: 1px solid #e7e8ef;
      border-left: 5px solid #667eea;
      border-radius: 14px;
      padding: 14px;
    }
    .badge {
      display: inline-block;
      background: #667eea;
      color: #fff;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .mono {
      background: #fff;
      border: 1px solid #e7e8ef;
      border-radius: 12px;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .plot-wrap {
      background: #fff;
      border: 1px solid #e7e8ef;
      border-radius: 14px;
      padding: 14px;
    }
    .plot-wrap h3 { margin: 0 0 10px 0; color: #667eea; }
    .plot-img {
      width: 100%;
      height: auto;
      max-width: 1400px;
      display: block;
      border-radius: 12px;
      border: 1px solid #eef0f7;
      box-shadow: 0 10px 28px rgba(0,0,0,0.08);
    }
    .status { margin-top: 10px; }
    .ok, .err {
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid;
    }
    .ok  { background: #ecffef; color: #1f7a2a; border-color: #bfe6c6; }
    .err { background: #ffecec; color: #9a1b1b; border-color: #f0b9b9; }

    .loading {
      display: none;
      padding: 16px;
      text-align: center;
      color: #667eea;
      font-weight: 800;
    }
    .loading.active { display: block; }
    .spinner {
      width: 44px; height: 44px;
      border-radius: 50%;
      border: 4px solid rgba(102,126,234,0.2);
      border-top-color: rgba(102,126,234,1);
      margin: 8px auto 10px auto;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ODE Solver</h1>
      <p>Runs your standalone Python logic in-browser (Pyodide) and renders full-size Matplotlib images.</p>
    </div>

    <div class="content">
      <div class="controls">
        <div class="tabs">
          <button class="tab active" id="tabbtn-1d" type="button">1D</button>
          <button class="tab" id="tabbtn-2d" type="button">2D</button>
        </div>

        <div id="tab-1d" class="tab-content active">
          <div class="form-group">
            <label>dx/dt =</label>
            <input type="text" id="dx-1d" value="2*x" />
          </div>
          <div class="form-group">
            <label>x‚ÇÄ</label>
            <input type="number" id="x0-1d" value="1" step="0.1" />
          </div>
          <div class="form-group">
            <label>t_total</label>
            <input type="number" id="t-1d" value="5" step="0.1" />
          </div>
          <div class="form-group">
            <label>n</label>
            <input type="number" id="n-1d" value="100" step="10" />
          </div>
        </div>

        <div id="tab-2d" class="tab-content">
          <div class="form-group">
            <label>dx/dt =</label>
            <input type="text" id="dx-2d" value="y" />
          </div>
          <div class="form-group">
            <label>dy/dt =</label>
            <input type="text" id="dy-2d" value="-x" />
          </div>
          <div class="form-group">
            <label>x‚ÇÄ</label>
            <input type="number" id="x0-2d" value="1" step="0.1" />
          </div>
          <div class="form-group">
            <label>y‚ÇÄ</label>
            <input type="number" id="y0-2d" value="0" step="0.1" />
          </div>
          <div class="form-group">
            <label>t_total</label>
            <input type="number" id="t-2d" value="20" step="0.1" />
          </div>
          <div class="form-group">
            <label>n</label>
            <input type="number" id="n-2d" value="1000" step="10" />
          </div>
          <div class="form-group">
            <label>Method</label>
            <select id="method-2d">
              <option value="lie_trotter">Lie-Trotter</option>
              <option value="strang">Strang</option>
              <option value="third">Third Order</option>
              <option value="sixth">Sixth Order</option>
              <option value="eight">Eighth Order</option>
              <option value="tenth">Tenth Order</option>
              <option value="twelfth">Twelfth Order</option>
              <option value="fourteenth">Fourteenth Order</option>
            </select>
          </div>
        </div>

        <button class="btn" id="solve-btn" type="button">üöÄ Solve System</button>
        <div class="status" id="status"></div>
      </div>

      <div class="results">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <div id="loading-text">Initializing Python...</div>
        </div>

        <div id="info"></div>
        <div id="plots"></div>
        <div id="raw"></div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // Tiny helper
    const $ = (id) => document.getElementById(id);

    let pyodide = null;
    let currentTab = "1d";

    function setStatusOk(msg) {
      const el = $("status");
      if (!el) return;
      el.innerHTML = `<div class="ok">‚úÖ ${msg}</div>`;
    }
    function setStatusErr(msg) {
      const el = $("status");
      if (!el) return;
      el.innerHTML = `<div class="err">‚ùå ${msg}</div>`;
    }
    function showLoading(text) {
      const lt = $("loading-text");
      const l = $("loading");
      if (lt) lt.textContent = text;
      if (l) l.classList.add("active");
    }
    function hideLoading() {
      const l = $("loading");
      if (l) l.classList.remove("active");
    }

    function switchTab(tab) {
      currentTab = tab;
      $("tabbtn-1d")?.classList.toggle("active", tab === "1d");
      $("tabbtn-2d")?.classList.toggle("active", tab === "2d");
      $("tab-1d")?.classList.toggle("active", tab === "1d");
      $("tab-2d")?.classList.toggle("active", tab === "2d");
    }

    async function initPyodide() {
      showLoading("Initializing Python environment...");
      try {
        if (typeof loadPyodide !== "function") {
          throw new Error("Pyodide script did not load (loadPyodide is undefined). If you're opening this from a file:// URL, serve it with a local web server. Also disable strict tracking prevention for cdn.jsdelivr.net or self-host pyodide.");
        }
        pyodide = await loadPyodide();
        await pyodide.loadPackage(["numpy", "scipy", "sympy", "matplotlib"]);
        hideLoading();
        setStatusOk("Python environment ready.");
        setTimeout(() => ($("status").innerHTML = ""), 2200);
      } catch (e) {
        hideLoading();
        setStatusErr("Failed to initialize Pyodide: " + (e?.message || String(e)));
      }
    }

    function escapeForPyString(s) {
      // Regex-free escape that cannot break JS parsing
      return JSON.stringify(String(s)).slice(1, -1);
    }

    function escapeHtml(s) {
      // Avoid replaceAll (older engines) and regex literals.
      const str = String(s);
      return str
        .split("&").join("&amp;")
        .split("<").join("&lt;")
        .split(">\").join("&gt;")
        .split('"').join("&quot;")
        .split("'").join("&#039;");
    }

    async function solve() {
      if (!pyodide) {
        setStatusErr("Pyodide not ready yet.");
        return;
      }

      $("solve-btn").disabled = true;
      $("info").innerHTML = "";
      $("plots").innerHTML = "";
      $("raw").innerHTML = "";
      showLoading("Solving...");

      try {
        let pyCode = "";
        if (currentTab === "1d") {
          const dx = $("dx-1d").value;
          const x0 = parseFloat($("x0-1d").value);
          const tTotal = parseFloat($("t-1d").value);
          const n = parseInt($("n-1d").value, 10);
          pyCode = buildPython1D(dx, x0, tTotal, n);
        } else {
          const dx = $("dx-2d").value;
          const dy = $("dy-2d").value;
          const x0 = parseFloat($("x0-2d").value);
          const y0 = parseFloat($("y0-2d").value);
          const tTotal = parseFloat($("t-2d").value);
          const n = parseInt($("n-2d").value, 10);
          const method = $("method-2d").value;
          pyCode = buildPython2D(dx, dy, x0, y0, tTotal, n, method);
        }

        const jsonStr = await pyodide.runPythonAsync(pyCode);
        const result = JSON.parse(jsonStr);

        $("raw").innerHTML =
          `<div class="card"><div class="badge">Raw JSON</div><div class="mono">${escapeHtml(JSON.stringify(result, null, 2))}</div></div>`;

        if (!result.t_vals || !Array.isArray(result.t_vals) || result.t_vals.length < 2) {
          throw new Error("Solver returned no t_vals.");
        }
        if (currentTab === "1d") {
          if (!result.x_vals || !Array.isArray(result.x_vals) || result.x_vals.length < 2) {
            throw new Error("Solver returned no data to plot (x_vals missing).\");
          }
          renderInfo1D(result);
          await renderPlots1D(result);
        } else {
          if (!result.x_vals || !Array.isArray(result.x_vals) || result.x_vals.length < 2 ||
              !result.y_vals || !Array.isArray(result.y_vals) || result.y_vals.length < 2) {
            throw new Error("Solver returned no data to plot (x_vals/y_vals missing).\");
          }
          renderInfo2D(result);
          await renderPlots2D(result);
        }

        setStatusOk("Solved.");
        setTimeout(() => ($("status").innerHTML = ""), 1800);

      } catch (e) {
        setStatusErr(e?.message || String(e));
      } finally {
        hideLoading();
        $("solve-btn").disabled = false;
      }
    }

    // Wire up UI in a DOMContentLoaded handler so buttons ALWAYS work.
    window.addEventListener("DOMContentLoaded", () => {
      // Visible proof that JS loaded and handlers were attached
      setStatusOk("UI ready.");
      setTimeout(() => ($("status").innerHTML = ""), 1200);

      // Both addEventListener and onclick fallback
      const b1 = $("tabbtn-1d");
      const b2 = $("tabbtn-2d");
      const sb = $("solve-btn");

      if (b1) {
        b1.onclick = () => switchTab("1d");
        b1.addEventListener("click", () => switchTab("1d"));
      }
      if (b2) {
        b2.onclick = () => switchTab("2d");
        b2.addEventListener("click", () => switchTab("2d"));
      }
      if (sb) {
        sb.onclick = solve;
        sb.addEventListener("click", solve);
      }

      // Init Pyodide after wiring UI so tabs work even if Pyodide fails.
      initPyodide();
    });
  </script>
</body>
</html>
