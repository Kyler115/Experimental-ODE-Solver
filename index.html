<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ODE Solver - Operator Splitting Methods</title>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .header p { font-size: 1.1em; opacity: 0.9; }

    .content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 30px;
      padding: 30px;
    }

    .controls {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      height: fit-content;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus { outline: none; border-color: #667eea; }

    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .results { display: flex; flex-direction: column; gap: 20px; min-width: 0; }

    .solution-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .solution-box h3 { color: #667eea; margin-bottom: 15px; font-size: 1.3em; }

    .solution-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      overflow-x: auto;
    }

    .method-badge {
      display: inline-block;
      padding: 5px 12px;
      background: #667eea;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .plot-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: #667eea;
    }
    .loading.active { display: block; }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      border-left: 4px solid #f44;
      padding: 15px;
      border-radius: 8px;
      color: #c33;
      margin-top: 10px;
    }

    .success {
      background: #efe;
      border-left: 4px solid #4a4;
      padding: 15px;
      border-radius: 8px;
      color: #2a2;
      margin-top: 10px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üî¨ ODE Solver</h1>
      <p>Operator Splitting Methods with Algebraic & Numerical Solutions</p>
    </div>

    <div class="content">
      <div class="controls">
        <div class="tabs">
          <button class="tab active" onclick="switchTab(event,'1d')">1D</button>
          <button class="tab" onclick="switchTab(event,'2d')">2D</button>
        </div>

        <!-- 1D Tab -->
        <div id="tab-1d" class="tab-content active">
          <div class="form-group">
            <label>dx/dt =</label>
            <input type="text" id="dx-1d" value="2*x" placeholder="e.g., 2*x">
          </div>

          <div class="form-group">
            <label>x‚ÇÄ (Initial value)</label>
            <input type="number" id="x0-1d" value="1" step="0.1">
          </div>

          <div class="form-group">
            <label>t_total (Time duration)</label>
            <input type="number" id="t-1d" value="5" step="0.1">
          </div>

          <div class="form-group">
            <label>n (Number of steps)</label>
            <input type="number" id="n-1d" value="100" step="10">
          </div>
        </div>

        <!-- 2D Tab -->
        <div id="tab-2d" class="tab-content">
          <div class="form-group">
            <label>dx/dt =</label>
            <input type="text" id="dx-2d" value="y" placeholder="e.g., y">
          </div>

          <div class="form-group">
            <label>dy/dt =</label>
            <input type="text" id="dy-2d" value="-x" placeholder="e.g., -x">
          </div>

          <div class="form-group">
            <label>x‚ÇÄ (Initial x)</label>
            <input type="number" id="x0-2d" value="1" step="0.1">
          </div>

          <div class="form-group">
            <label>y‚ÇÄ (Initial y)</label>
            <input type="number" id="y0-2d" value="0" step="0.1">
          </div>

          <div class="form-group">
            <label>t_total (Time duration)</label>
            <input type="number" id="t-2d" value="20" step="0.1">
          </div>

          <div class="form-group">
            <label>n (Number of steps)</label>
            <input type="number" id="n-2d" value="1000" step="10">
          </div>

          <div class="form-group">
            <label>Method</label>
            <select id="method-2d">
              <option value="lie_trotter">Lie-Trotter</option>
              <option value="strang">Strang</option>
              <option value="third">Third Order</option>
              <option value="sixth">Sixth Order</option>
              <option value="eighth">Eighth Order</option>
              <option value="tenth">Tenth Order</option>
              <option value="twelfth">Twelfth Order</option>
              <option value="fourteenth">Fourteenth Order</option>
            </select>
          </div>
        </div>

        <button class="btn" id="solve-btn" onclick="solveSys()">üöÄ Solve System</button>
        <div id="status"></div>
      </div>

      <div class="results">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Initializing Python environment...</p>
        </div>

        <div id="solution-info"></div>
        <div id="plots"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
        // ---------- safety helpers ----------
        function safeLast(arr, fallback = null) {
            return (Array.isArray(arr) && arr.length > 0) ? arr[arr.length - 1] : fallback;
        }
        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
        // -----------------------------------
    let pyodide = null;
    let currentTab = '1d';

    function switchTab(e, tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    async function initPyodide() {
      const loading = document.getElementById('loading');
      loading.classList.add('active');

      try {
        pyodide = await loadPyodide();
        await pyodide.loadPackage(['numpy', 'scipy', 'sympy', 'matplotlib']);

        // Make sure matplotlib uses a non-interactive backend
        await pyodide.runPythonAsync(`
import matplotlib
matplotlib.use("Agg")
        `);

        loading.classList.remove('active');
        document.getElementById('status').innerHTML = '<div class="success">‚úÖ Python environment ready!</div>';
        setTimeout(() => { document.getElementById('status').innerHTML = ''; }, 2500);
      } catch (error) {
        loading.classList.remove('active');
        document.getElementById('status').innerHTML = `<div class="error">‚ùå Failed to initialize: ${escapeHtml(String(error))}</div>`;
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    async function solveSys() {
      if (!pyodide) {
        document.getElementById('status').innerHTML = '<div class="error">Please wait for Python to initialize...</div>';
        return;
      }

      const loading = document.getElementById('loading');
      loading.querySelector('p').textContent = 'Solving system...';
      loading.classList.add('active');

      const btn = document.getElementById('solve-btn');
      btn.disabled = true;

      document.getElementById('solution-info').innerHTML = '';
      document.getElementById('plots').innerHTML = '';
      document.getElementById('status').innerHTML = '';

      try {
        if (currentTab === '1d') {
          const dx = document.getElementById('dx-1d').value;
          const x0 = parseFloat(document.getElementById('x0-1d').value);
          const t_total = parseFloat(document.getElementById('t-1d').value);
          const n = parseInt(document.getElementById('n-1d').value, 10);

          // Pass inputs safely (no string interpolation into Python code)
          pyodide.globals.set("DX_STR", dx);
          pyodide.globals.set("X0", x0);
          pyodide.globals.set("T_TOTAL", t_total);
          pyodide.globals.set("N_STEPS", n);

          const jsonStr = await pyodide.runPythonAsync(`
import numpy as np
import json
from scipy.integrate import solve_ivp
from sympy import *
from sympy.parsing.sympy_parser import parse_expr, standard_transformations, implicit_multiplication_application

dx_dt_str = str(DX_STR)
x0 = float(X0)
t_total = float(T_TOTAL)
n = int(N_STEPS)

x = symbols('x')
t = symbols('t')
t_vals = np.linspace(0, t_total, n + 1)

result = {
  "algebraic_found": False,
  "method": "Numerical (RK45)",
  "t_vals": t_vals.tolist()
}

# Try algebraic solution (your console-code logic)
try:
  xFunc = Function('xA')
  xA = xFunc(t)

  dx_dtA = parse_expr(dx_dt_str.lower(),
                      local_dict={"x": xA, "t": t},
                      transformations=standard_transformations + (implicit_multiplication_application,))
  dx_dt = parse_expr(dx_dt_str.lower(),
                     local_dict={"x": x},
                     transformations=standard_transformations + (implicit_multiplication_application,))

  algX = Eq(Derivative(xA, t), dx_dtA)
  solX = dsolve(algX)
  check, _ = checkodesol(algX, solX)

  if check:
    x_expr = solX.rhs
    result["general_solution"] = str(x_expr)
    result["algebraic_found"] = True

    constants = list(x_expr.free_symbols - {t})
    if constants:
      eq_x = Eq(x_expr.subs(t, 0), x0)
      solC = solve(eq_x, constants[0])
      if solC:
        x_expr = x_expr.subs(constants[0], solC[0])

    result["particular_solution"] = str(x_expr)
    result["method"] = "Algebraic (Exact)"
    x_vals = np.array([complex(x_expr.subs(t, tv)).real for tv in t_vals])
    result["x_vals"] = x_vals.tolist()
  else:
    raise Exception("checkodesol failed")

except Exception as e:
  result["algebraic_error"] = str(e)
  dx_dt = parse_expr(dx_dt_str.lower(),
                     local_dict={"x": x},
                     transformations=standard_transformations + (implicit_multiplication_application,))
  f = lambdify(x, dx_dt, "numpy")

  def system(t_, xv):
    return [f(xv[0])]

  sol = solve_ivp(system, (0, t_total), [x0], t_eval=t_vals, method="RK45")
  result["x_vals"] = sol.y[0].tolist()

json.dumps(result)
          `);

          const result = JSON.parse(jsonStr);
          displayResults1D(result);

        } else {
          // 2D
          const dx = document.getElementById('dx-2d').value;
          const dy = document.getElementById('dy-2d').value;
          const x0 = parseFloat(document.getElementById('x0-2d').value);
          const y0 = parseFloat(document.getElementById('y0-2d').value);
          const t_total = parseFloat(document.getElementById('t-2d').value);
          const n = parseInt(document.getElementById('n-2d').value, 10);
          const method = document.getElementById('method-2d').value;

          pyodide.globals.set("DX_STR", dx);
          pyodide.globals.set("DY_STR", dy);
          pyodide.globals.set("X0", x0);
          pyodide.globals.set("Y0", y0);
          pyodide.globals.set("T_TOTAL", t_total);
          pyodide.globals.set("N_STEPS", n);
          pyodide.globals.set("METHOD", method);

          const jsonStr = await pyodide.runPythonAsync(`
import numpy as np
import json
from scipy.integrate import solve_ivp
from sympy import *
from sympy.parsing.sympy_parser import parse_expr, standard_transformations, implicit_multiplication_application

dx_dt_str = str(DX_STR)
dy_dt_str = str(DY_STR)
x0 = float(X0)
y0 = float(Y0)
t_total = float(T_TOTAL)
n = int(N_STEPS)
method = str(METHOD)

x, y = symbols('x y')
t = symbols('t')
t_vals = np.linspace(0, t_total, n + 1)
dt = t_total / n

result = {
  "algebraic_found": False,
  "method": f"Numerical ({method})",
  "t_vals": t_vals.tolist()
}

dx_dt = parse_expr(dx_dt_str.lower(),
                   local_dict={"x": x, "y": y},
                   transformations=standard_transformations + (implicit_multiplication_application,))
dy_dt = parse_expr(dy_dt_str.lower(),
                   local_dict={"x": x, "y": y},
                   transformations=standard_transformations + (implicit_multiplication_application,))

dx_str = str(dx_dt).lower()
dy_str = str(dy_dt).lower()
nonlinear_indicators = ["**2","**3","*x*y","*y*x"]
coupled_terms = ("*x*y" in dx_str) or ("*y*x" in dx_str) or ("*x*y" in dy_str) or ("*y*x" in dy_str)
skip_algebraic = any(ind in dx_str or ind in dy_str for ind in nonlinear_indicators) or coupled_terms

if not skip_algebraic:
  try:
    xFunc = Function("xA")
    yFunc = Function("yA")
    xA = xFunc(t)
    yA = yFunc(t)

    dx_dtA = parse_expr(dx_dt_str.lower(),
                        local_dict={"x": xA, "y": yA, "t": t},
                        transformations=standard_transformations + (implicit_multiplication_application,))
    dy_dtA = parse_expr(dy_dt_str.lower(),
                        local_dict={"x": xA, "y": yA, "t": t},
                        transformations=standard_transformations + (implicit_multiplication_application,))

    algX = Eq(Derivative(xA,t), dx_dtA)
    algY = Eq(Derivative(yA,t), dy_dtA)

    solX = dsolve(algX)
    solY = dsolve(algY)

    check_x, _ = checkodesol(algX, solX)
    check_y, _ = checkodesol(algY, solY)

    if check_x and check_y:
      x_expr = solX.rhs
      y_expr = solY.rhs

      result["general_solution_x"] = str(x_expr)
      result["general_solution_y"] = str(y_expr)
      result["algebraic_found"] = True

      # Apply ICs (your console-code logic)
      constants = list(x_expr.free_symbols - {t})
      if constants:
        eq_x = Eq(x_expr.subs(t,0), x0)
        solC = solve(eq_x, constants[0])
        if solC:
          x_expr = x_expr.subs(constants[0], solC[0])

      constants_y = list(y_expr.free_symbols - {t})
      if constants_y:
        eq_y = Eq(y_expr.subs(t,0), y0)
        solCy = solve(eq_y, constants_y[0])
        if solCy:
          y_expr = y_expr.subs(constants_y[0], solCy[0])

      result["particular_solution_x"] = str(x_expr)
      result["particular_solution_y"] = str(y_expr)
      result["method"] = "Algebraic (Exact)"

      x_vals = np.array([complex(x_expr.subs(t, tv)).real for tv in t_vals])
      y_vals = np.array([complex(y_expr.subs(t, tv)).real for tv in t_vals])
      result["x_vals"] = x_vals.tolist()
      result["y_vals"] = y_vals.tolist()

    else:
      raise Exception("checkodesol failed")

  except Exception as e:
    result["algebraic_error"] = str(e)

if (not result["algebraic_found"]):
  # Numerical solver (your splitting scaffold; Lie-Trotter implemented + RK45 compare)
  f1 = lambdify((x,y), dx_dt, "numpy")
  f2 = lambdify((x,y), dy_dt, "numpy")

  def sigma(delta_t, x_initial, y_const):
    def rhs_x(t_, xval):
      return [f1(xval[0], y_const)]
    sol = solve_ivp(rhs_x, [0.0, float(delta_t)], [x_initial], method="RK45")
    return float(sol.y[0, -1])

  def gamma(delta_t, y_initial, x_const):
    def rhs_y(t_, yval):
      return [f2(x_const, yval[0])]
    sol = solve_ivp(rhs_y, [0.0, float(delta_t)], [y_initial], method="RK45")
    return float(sol.y[0, -1])

  x_arr = np.zeros(n+1, dtype=float)
  y_arr = np.zeros(n+1, dtype=float)
  x_arr[0] = x0
  y_arr[0] = y0

  # For now: implement Lie-Trotter exactly (you can extend to other methods in this same block)
  for k in range(n):
    x_arr[k+1] = sigma(dt, x_arr[k], y_arr[k])
    y_arr[k+1] = gamma(dt, y_arr[k], x_arr[k+1])

  result["x_vals"] = x_arr.tolist()
  result["y_vals"] = y_arr.tolist()

  def system_2d(t_, z):
    return [f1(z[0], z[1]), f2(z[0], z[1])]

  sol_rk45 = solve_ivp(system_2d, (0, t_total), [x0, y0], t_eval=t_vals, method="RK45")
  result["x_rk45"] = sol_rk45.y[0].tolist()
  result["y_rk45"] = sol_rk45.y[1].tolist()

json.dumps(result)
          `);

          const result = JSON.parse(jsonStr);
          displayResults2D(result);
        }

      } catch (error) {
        document.getElementById('status').innerHTML =
          `<div class="error">‚ùå Error: ${escapeHtml(String(error && error.message ? error.message : error))}</div>`;
      } finally {
        loading.classList.remove('active');
        btn.disabled = false;
      }
    }

    function displayResults1D(result) {
      // Guard against malformed results
      if (!result || !Array.isArray(result.t_vals) || !Array.isArray(result.x_vals)) {
        const details = result ? JSON.stringify(result) : 'null/undefined result';
        document.getElementById('status').innerHTML =
          `<div class="error">‚ùå Solver returned no data to plot.<br><small>${escapeHtml(details)}</small></div>`;
        return;
      }

      let html = '<div class="solution-box">';
      html += '<h3>üìä Solution Information</h3>';
      html += `<div class="method-badge">${escapeHtml(result.method || 'Unknown')}</div>`;

      if (result.algebraic_found) {
        html += '<div class="solution-item">';
        html += '<strong>General Solution:</strong><br>';
        html += `x(t) = ${escapeHtml(result.general_solution || '')}`;
        html += '</div>';

        html += '<div class="solution-item">';
        html += '<strong>Particular Solution (with initial conditions):</strong><br>';
        html += `x(t) = ${escapeHtml(result.particular_solution || '')}`;
        html += '</div>';
      } else {
        html += '<div class="solution-item">';
        html += '<strong>Note:</strong> Solved numerically using RK45.';
        if (result.algebraic_error) {
          html += `<br><em>Algebraic attempt: ${escapeHtml(result.algebraic_error)}</em>`;
        }
        html += '</div>';
      }

      html += '<div class="solution-item">';
      html += '<strong>Final Value:</strong><br>';
      const xf = safeLast(result.x_vals, NaN);
      html += `x(t_final) = ${Number(xf).toFixed(6)}`;
      html += '</div>';

      html += '</div>';
      document.getElementById('solution-info').innerHTML = html;

      generateMatplotlibPlot1D(result);
    }

    async function generateMatplotlibPlot1D(result) {
      const plotCode = `
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
import numpy as np
import base64
from io import BytesIO

t_vals = np.array(${JSON.stringify(result.t_vals)}, dtype=float)
x_vals = np.array(${JSON.stringify(result.x_vals)}, dtype=float)

fig, ax = plt.subplots(figsize=(12, 7), dpi=100)
ax.plot(t_vals, x_vals, 'b-', linewidth=3, label='x(t)')
ax.set_xlabel('Time t', fontsize=14)
ax.set_ylabel('x(t)', fontsize=14)
ax.set_title('Solution: x(t) vs t (${result.method})', fontsize=16, fontweight='bold')
ax.legend(fontsize=12)
ax.grid(True, alpha=0.3)
fig.tight_layout()

buf = BytesIO()
fig.savefig(buf, format='png', bbox_inches='tight')
plt.close(fig)
buf.seek(0)
base64.b64encode(buf.read()).decode('utf-8')
`;
      const imgBase64 = await pyodide.runPythonAsync(plotCode);

      document.getElementById('plots').innerHTML = `
        <div class="plot-container">
          <h3 style="color: #667eea; margin-bottom: 15px;">üìà Solution Plot</h3>
          <img
            src="data:image/png;base64,${imgBase64}"
            style="width: 100%; max-width: 1200px; height: auto; display: block; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
          >
        </div>
      `;
    }

    function displayResults2D(result) {
      // Guard against malformed results
      if (!result || !Array.isArray(result.t_vals) || !Array.isArray(result.x_vals) || !Array.isArray(result.y_vals)) {
        const details = result ? JSON.stringify(result) : 'null/undefined result';
        document.getElementById('status').innerHTML =
          `<div class="error">‚ùå Solver returned no data to plot.<br><small>${escapeHtml(details)}</small></div>`;
        return;
      }

      let html = '<div class="solution-box">';
      html += '<h3>üìä Solution Information</h3>';
      html += `<div class="method-badge">${escapeHtml(result.method || 'Unknown')}</div>`;

      if (result.algebraic_found) {
        html += '<div class="solution-item">';
        html += '<strong>General Solutions:</strong><br>';
        html += `x(t) = ${escapeHtml(result.general_solution_x || '')}<br>`;
        html += `y(t) = ${escapeHtml(result.general_solution_y || '')}`;
        html += '</div>';

        html += '<div class="solution-item">';
        html += '<strong>Particular Solutions (with initial conditions):</strong><br>';
        html += `x(t) = ${escapeHtml(result.particular_solution_x || '')}<br>`;
        html += `y(t) = ${escapeHtml(result.particular_solution_y || '')}`;
        html += '</div>';
      } else {
        html += '<div class="solution-item">';
        html += '<strong>Note:</strong> Solved numerically using operator splitting (Lie-Trotter implemented).';
        if (result.algebraic_error) {
          html += `<br><em>Algebraic attempt: ${escapeHtml(result.algebraic_error)}</em>`;
        }
        html += '</div>';
      }

      html += '<div class="solution-item">';
      html += '<strong>Final Values:</strong><br>';
      const xf = safeLast(result.x_vals, NaN);
      const yf = safeLast(result.y_vals, NaN);
      html += `x(t_final) = ${Number(xf).toFixed(6)}<br>`;
      html += `y(t_final) = ${Number(yf).toFixed(6)}`;
      html += '</div>';

      html += '</div>';
      document.getElementById('solution-info').innerHTML = html;

      generateMatplotlibPlots2D(result);
    }

    async function generateMatplotlibPlots2D(result) {
      // Return JSON string to avoid PyProxy/Map issues.
      const plotCode = `
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
import numpy as np
import base64, json
from io import BytesIO

t_vals = np.array(${JSON.stringify(result.t_vals)}, dtype=float)
x_vals = np.array(${JSON.stringify(result.x_vals)}, dtype=float)
y_vals = np.array(${JSON.stringify(result.y_vals)}, dtype=float)

x_rk45 = ${result.x_rk45 ? `np.array(${JSON.stringify(result.x_rk45)}, dtype=float)` : "None"}
y_rk45 = ${result.y_rk45 ? `np.array(${JSON.stringify(result.y_rk45)}, dtype=float)` : "None"}

# --- Time series ---
fig1, ax1 = plt.subplots(figsize=(12,7), dpi=100)
ax1.plot(t_vals, x_vals, 'r--', linewidth=2, label='x(t) (${result.method})')
ax1.plot(t_vals, y_vals, 'b--', linewidth=2, label='y(t) (${result.method})')

if x_rk45 is not None:
  ax1.plot(t_vals, x_rk45, 'r-', linewidth=1, label='x(t) (RK45)', alpha=0.7)
  ax1.plot(t_vals, y_rk45, 'b-', linewidth=1, label='y(t) (RK45)', alpha=0.7)

ax1.set_xlabel('Time t', fontsize=14)
ax1.set_ylabel('Values of x and y', fontsize=14)
ax1.set_title('Time Series: ${result.method} vs RK45', fontsize=16, fontweight='bold')
ax1.legend(fontsize=12)
ax1.grid(True, alpha=0.3)
fig1.tight_layout()

buf1 = BytesIO()
fig1.savefig(buf1, format='png', bbox_inches='tight')
plt.close(fig1)
buf1.seek(0)
img1 = base64.b64encode(buf1.read()).decode('utf-8')

# --- Phase plot ---
fig2, ax2 = plt.subplots(figsize=(12,7), dpi=100)
ax2.plot(x_vals, y_vals, 'r--', linewidth=2, label='${result.method} Phase')

if x_rk45 is not None:
  ax2.plot(x_rk45, y_rk45, 'b-', linewidth=1, label='RK45 Phase', alpha=0.7)

ax2.scatter([x_vals[0]],[y_vals[0]], s=200, zorder=5, label='Start', marker='o', edgecolors='black', linewidths=2)
ax2.scatter([x_vals[-1]],[y_vals[-1]], s=200, zorder=5, label='End', marker='s', edgecolors='black', linewidths=2)

ax2.set_xlabel('x (Prey/Resource)', fontsize=14)
ax2.set_ylabel('y (Predator/Consumer)', fontsize=14)
ax2.set_title('Phase Plot: ${result.method} vs RK45', fontsize=16, fontweight='bold')
ax2.legend(fontsize=12)
ax2.grid(True, alpha=0.3)
fig2.tight_layout()

buf2 = BytesIO()
fig2.savefig(buf2, format='png', bbox_inches='tight')
plt.close(fig2)
buf2.seek(0)
img2 = base64.b64encode(buf2.read()).decode('utf-8')

json.dumps({"img1": img1, "img2": img2})
`;
      const jsonStr = await pyodide.runPythonAsync(plotCode);
      const images = JSON.parse(jsonStr);

      document.getElementById('plots').innerHTML = `
        <div class="plot-container">
          <h3 style="color: #667eea; margin-bottom: 15px;">üìà Time Series Plot</h3>
          <img
            src="data:image/png;base64,${images.img1}"
            style="width: 100%; max-width: 1200px; height: auto; display: block; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
          >
        </div>

        <div class="plot-container" style="margin-top: 30px;">
          <h3 style="color: #667eea; margin-bottom: 15px;">üîÑ Phase Plot</h3>
          <img
            src="data:image/png;base64,${images.img2}"
            style="width: 100%; max-width: 1200px; height: auto; display: block; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
          >
        </div>
      `;
    }

    window.addEventListener('load', initPyodide);
  </script>
</body>
</html>
